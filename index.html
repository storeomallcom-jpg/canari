<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#0A0E1A"/>
<title>Ø±Ø¨Ø­ÙŠ â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESIGN TOKENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink:       #0A0E1A;
  --ink-2:     #111827;
  --ink-3:     #1C2536;
  --teal:      #00D4B8;
  --teal-dim:  #00A896;
  --gold:      #F5A623;
  --gold-dim:  #C8841A;
  --red:       #FF4D6D;
  --text:      #E8F0FF;
  --muted:     #6B7A99;
  --border:    rgba(255,255,255,0.07);
  --glass:     rgba(28,37,54,0.8);
  --safe-bot:  env(safe-area-inset-bottom, 0px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: 'Cairo', sans-serif;
  background: var(--ink);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
  padding-bottom: calc(72px + var(--safe-bot));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BACKGROUND â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-zellige {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 70% 50% at 15% 0%,   rgba(0,212,184,0.10) 0%, transparent 55%),
    radial-gradient(ellipse 50% 40% at 85% 100%,  rgba(245,166,35,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 40% 60% at 50% 50%,   rgba(255,77,109,0.04) 0%, transparent 60%);
}
/* Subtle geometric grid */
.bg-zellige::after {
  content: '';
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(0,212,184,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,184,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GLASS CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 20px;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.card-sm { border-radius: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TYPOGRAPHY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.grad-text {
  background: linear-gradient(135deg, var(--teal) 0%, var(--gold) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.teal  { color: var(--teal); }
.gold  { color: var(--gold); }
.red-c { color: var(--red);  }
.muted { color: var(--muted);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 13px 24px; border-radius: 14px;
  font-family: 'Cairo', sans-serif; font-size: 15px; font-weight: 700;
  border: none; cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.45; pointer-events: none; }

.btn-teal {
  background: linear-gradient(135deg, var(--teal), var(--teal-dim));
  color: #fff;
  box-shadow: 0 4px 20px rgba(0,212,184,0.3);
}
.btn-teal:hover { box-shadow: 0 8px 30px rgba(0,212,184,0.45); transform: translateY(-1px); }

.btn-gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-dim));
  color: #0A0E1A; font-weight: 800;
  box-shadow: 0 4px 20px rgba(245,166,35,0.3);
}
.btn-gold:hover { box-shadow: 0 8px 30px rgba(245,166,35,0.45); transform: translateY(-1px); }

.btn-ghost {
  background: var(--border);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text);
}
.btn-ghost:hover { border-color: var(--teal); color: var(--teal); }

.btn-full { width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INPUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field {
  width: 100%;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 12px;
  padding: 13px 16px;
  color: var(--text);
  font-family: 'Cairo', sans-serif;
  font-size: 15px;
  outline: none;
  transition: border-color 0.25s, box-shadow 0.25s;
  -webkit-appearance: none;
}
.field:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 3px rgba(0,212,184,0.12);
}
.field::placeholder { color: var(--muted); font-size: 14px; }
.field-label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 7px; font-weight: 600; letter-spacing: 0.3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RANGE SLIDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
input[type=range] {
  -webkit-appearance: none; width: 100%; height: 5px;
  border-radius: 3px; background: rgba(255,255,255,0.1); outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 20px; height: 20px;
  border-radius: 50%; background: var(--teal);
  box-shadow: 0 0 8px rgba(0,212,184,0.6);
}
input[type=range]::-moz-range-thumb {
  width: 20px; height: 20px; border: none; border-radius: 50%; background: var(--teal);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STAT CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-card {
  padding: 18px 16px;
  position: relative; overflow: hidden;
}
.stat-card::before {
  content: ''; position: absolute;
  inset: 0; opacity: 0.06; border-radius: 20px;
}
.stat-card.c-teal::before  { background: var(--teal); }
.stat-card.c-gold::before  { background: var(--gold);  }
.stat-card.c-red::before   { background: var(--red);   }
.stat-card.c-blue::before  { background: #60A5FA;       }
.stat-icon {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; margin-bottom: 12px;
}
.stat-icon.c-teal { background: rgba(0,212,184,0.15); }
.stat-icon.c-gold { background: rgba(245,166,35,0.15); }
.stat-icon.c-red  { background: rgba(255,77,109,0.15); }
.stat-icon.c-blue { background: rgba(96,165,250,0.15); }
.stat-num  { font-size: 1.75rem; font-weight: 900; line-height: 1.1; }
.stat-lbl  { font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 600; }
.stat-delta{ font-size: 11px; font-weight: 700; margin-top: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
  background: rgba(10,14,26,0.96);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding-bottom: var(--safe-bot);
  display: flex;
}
.nav-item {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 4px; padding: 10px 6px 8px;
  cursor: pointer; -webkit-tap-highlight-color: transparent;
  transition: color 0.2s;
  text-decoration: none; color: var(--muted);
  font-size: 10px; font-weight: 700; font-family: 'Cairo', sans-serif;
}
.nav-item .nav-icon {
  width: 28px; height: 28px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; transition: background 0.2s, transform 0.2s;
}
.nav-item.active { color: var(--teal); }
.nav-item.active .nav-icon {
  background: rgba(0,212,184,0.15);
  transform: translateY(-2px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top-bar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,14,26,0.92);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOKEN BADGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.token-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(245,166,35,0.12);
  border: 1px solid rgba(245,166,35,0.3);
  border-radius: 20px; padding: 5px 12px;
  font-size: 12px; font-weight: 700; color: var(--gold);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.sheet {
  width: 100%; max-width: 520px;
  border-radius: 24px 24px 0 0;
  padding: 24px 24px calc(24px + var(--safe-bot));
  transform: translateY(60px);
  transition: transform 0.4s cubic-bezier(.34,1.4,.64,1);
}
.overlay.open .sheet { transform: translateY(0); }
.sheet-handle {
  width: 40px; height: 4px; border-radius: 2px;
  background: var(--border); margin: 0 auto 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tab-row {
  display: flex; gap: 6px;
  background: rgba(255,255,255,0.04);
  border-radius: 12px; padding: 4px;
}
.tab-btn-sm {
  flex: 1; padding: 8px; border-radius: 9px;
  font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; border: none; background: transparent; color: var(--muted);
  transition: all 0.2s;
}
.tab-btn-sm.active {
  background: rgba(0,212,184,0.15);
  color: var(--teal);
  border: 1px solid rgba(0,212,184,0.25);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AI RESULT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ai-card {
  background: rgba(0,212,184,0.06);
  border: 1px solid rgba(0,212,184,0.18);
  border-radius: 16px; padding: 18px;
  position: relative;
}
.price-interval {
  background: rgba(245,166,35,0.12);
  border: 1px solid rgba(245,166,35,0.3);
  border-radius: 12px; padding: 14px 18px;
  text-align: center; margin-bottom: 14px;
}
.price-interval .label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
.price-interval .range { font-size: 1.6rem; font-weight: 900; color: var(--gold); letter-spacing: -0.5px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROFIT HEALTH BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.health-bar { height: 8px; background: rgba(255,255,255,0.07); border-radius: 4px; overflow: hidden; }
.health-fill { height: 100%; border-radius: 4px; transition: width 1.2s cubic-bezier(.34,1.4,.64,1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DIVIDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.divider { height: 1px; background: var(--border); margin: 0 -4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING DOTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dots span {
  display: inline-block; width: 7px; height: 7px;
  border-radius: 50%; background: var(--teal); margin: 0 3px;
  animation: dot-bounce 1.2s infinite;
}
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dot-bounce { 0%,80%,100%{transform:scale(0.5);opacity:0.3} 40%{transform:scale(1);opacity:1} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast {
  position: fixed; bottom: calc(85px + var(--safe-bot)); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink-3); border: 1px solid var(--border);
  border-radius: 12px; padding: 12px 22px;
  font-size: 13px; font-weight: 600; z-index: 1000;
  white-space: nowrap; opacity: 0;
  transition: all 0.35s cubic-bezier(.34,1.4,.64,1);
  pointer-events: none;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANIMATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fade-up {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-up { animation: fade-up 0.5s ease forwards; }
.d1 { animation-delay: 0.05s; }
.d2 { animation-delay: 0.1s;  }
.d3 { animation-delay: 0.15s; }
.d4 { animation-delay: 0.2s;  }
.d5 { animation-delay: 0.25s; }
.d6 { animation-delay: 0.3s;  }
.fade-up:not(.no-init) { opacity: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCROLLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
select.field { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236B7A99' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 14px center; padding-left: 36px; }
select.field option { background: #1C2536; color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 768px) {
  body { padding-bottom: 0; }
  .bottom-nav { display: none; }
  .desktop-sidebar {
    position: fixed; top: 0; right: 0; bottom: 0; width: 240px;
    background: rgba(10,14,26,0.98); border-left: 1px solid var(--border);
    display: flex; flex-direction: column; padding: 24px 0;
    backdrop-filter: blur(20px);
  }
  .main-content { margin-right: 240px; }
}
@media (max-width: 767px) {
  .desktop-sidebar { display: none; }
  .main-content { margin-right: 0; }
}
</style>
</head>
<body>
<div class="bg-zellige"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast">Ø±Ø³Ø§Ù„Ø©</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authModal" class="overlay" onclick="if(event.target===this)closeModal()">
  <div class="sheet card">
    <div class="sheet-handle"></div>
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-xl font-black grad-text" id="sheetTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p class="text-xs muted mt-1">Ù…Ø¬Ø§Ù†ÙŠ 100% â€” Ø¨Ø¯ÙˆÙ† Ø¨Ø·Ø§Ù‚Ø©</p>
      </div>
      <button onclick="closeModal()" class="w-9 h-9 rounded-full btn-ghost flex items-center justify-center text-lg">âœ•</button>
    </div>

    <div class="tab-row mb-6">
      <button class="tab-btn-sm active" id="tl" onclick="switchTab('login')">Ø¯Ø®ÙˆÙ„</button>
      <button class="tab-btn-sm" id="ts" onclick="switchTab('signup')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <form id="authForm" onsubmit="doAuth(event)" class="space-y-4">
      <div id="fName" class="hidden">
        <label class="field-label">Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="iName" class="field" placeholder="Ø£Ù…ÙŠÙ† Ø¨Ù†Ø¹Ù„ÙŠ"/>
      </div>
      <div>
        <label class="field-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="iEmail" class="field" placeholder="you@example.com" required/>
      </div>
      <div>
        <label class="field-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="iPass" class="field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
      </div>
      <div id="fRef" class="hidden">
        <label class="field-label">ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" id="iRef" class="field" placeholder="REF-XXXXXX"/>
      </div>
      <button type="submit" id="authBtn" class="btn btn-teal btn-full text-base mt-2">
        <span id="authBtnLbl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
      </button>
    </form>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESKTOP SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="desktop-sidebar" id="desktopSidebar">
  <div class="px-6 mb-8">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl flex items-center justify-center text-xl font-black" style="background:linear-gradient(135deg,var(--teal),var(--gold))">Ø±</div>
      <span class="text-lg font-black grad-text">Ø±Ø¨Ø­ÙŠ</span>
    </div>
  </div>
  <div class="flex-1 px-3 space-y-1" id="sidebarItems">
    <a href="index.html" class="flex items-center gap-3 px-4 py-3 rounded-14 text-sm font-700 transition-all" style="border-radius:12px;background:rgba(0,212,184,0.12);color:var(--teal);font-weight:700">
      <span class="text-lg">ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    </a>
    <a href="settings.html" class="flex items-center gap-3 px-4 py-3 rounded-14 text-sm transition-all hover:bg-white/5" style="border-radius:12px;color:var(--muted);font-weight:600">
      <span class="text-lg">âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    </a>
    <a href="rewards.html" class="flex items-center gap-3 px-4 py-3 rounded-14 text-sm transition-all hover:bg-white/5" style="border-radius:12px;color:var(--muted);font-weight:600">
      <span class="text-lg">ğŸ</span> Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª
    </a>
  </div>
  <div class="px-6 mt-4">
    <div id="sdkTokens" class="token-chip w-full justify-center mb-4">ğŸª™ â€” Ø±ØµÙŠØ¯</div>
    <div id="sdkUserInfo" class="text-xs muted text-center mb-3 truncate"></div>
    <button id="sdkAuthBtn" onclick="openModal()" class="btn btn-ghost btn-full text-sm py-2">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    <button id="sdkSignOut" onclick="doSignOut()" class="btn btn-full text-sm py-2 mt-2 hidden" style="background:transparent;border:1px solid rgba(255,77,109,0.3);color:var(--red);border-radius:14px">Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-content relative z-10">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-10 flex items-center justify-center font-black text-sm" style="background:linear-gradient(135deg,var(--teal),var(--gold));border-radius:10px">Ø±</div>
      <span class="font-black text-base grad-text">Ø±Ø¨Ø­ÙŠ</span>
    </div>
    <div class="flex items-center gap-3">
      <div class="token-chip" id="topTokenChip">ğŸª™ â€” Ø±ØµÙŠØ¯</div>
      <div class="w-8 h-8 rounded-full flex items-center justify-center font-black text-sm cursor-pointer" style="background:linear-gradient(135deg,var(--teal),var(--gold));color:#0A0E1A" id="topAvatar" onclick="currentUser ? null : openModal()">ØŸ</div>
    </div>
  </div>

  <!-- â”€â”€â”€ DASHBOARD VIEW â”€â”€â”€ -->
  <div id="dashView" class="px-4 py-5 space-y-5">

    <!-- Greeting -->
    <div class="fade-up d1">
      <p class="text-xs muted font-600">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ</p>
      <h1 class="text-2xl font-black" id="greetName">Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…ØºØ±Ø¨ÙŠ ğŸ‘‹</h1>
    </div>

    <!-- 4 Stat Cards -->
    <div class="grid grid-cols-2 gap-3 fade-up d2">
      <div class="card stat-card c-teal">
        <div class="stat-icon c-teal">ğŸ’°</div>
        <div class="stat-num teal" id="s-profit">â€”</div>
        <div class="stat-lbl">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ (Ø¯.Ù….)</div>
      </div>
      <div class="card stat-card c-gold">
        <div class="stat-icon c-gold">ğŸ“ˆ</div>
        <div class="stat-num gold" id="s-roi">â€”</div>
        <div class="stat-lbl">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
      </div>
      <div class="card stat-card c-blue">
        <div class="stat-icon c-blue">ğŸšš</div>
        <div class="stat-num" style="color:#60A5FA" id="s-delivery">â€”</div>
        <div class="stat-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ø§Ø¬Ø­</div>
      </div>
      <div class="card stat-card c-red" style="cursor:pointer" onclick="currentUser ? null : openModal()">
        <div class="stat-icon c-red">ğŸª™</div>
        <div class="stat-num" style="color:var(--gold)" id="s-tokens">â€”</div>
        <div class="stat-lbl">Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</div>
      </div>
    </div>

    <!-- Health bar -->
    <div class="card p-4 fade-up d3">
      <div class="flex justify-between items-center mb-3">
        <span class="text-sm font-700">ØµØ­Ø© Ø§Ù„Ø±Ø¨Ø­ÙŠØ©</span>
        <span class="text-xs font-800" id="healthLbl" style="color:var(--muted)">â€” Ø§Ø­Ø³Ø¨ Ø£ÙˆÙ„Ø§Ù‹</span>
      </div>
      <div class="health-bar">
        <div class="health-fill" id="healthFill" style="width:0%;background:linear-gradient(90deg,var(--red),var(--gold),var(--teal))"></div>
      </div>
    </div>

    <!-- Quick Calc Button -->
    <button class="btn btn-teal btn-full py-4 text-base fade-up d4" onclick="showCalc()">
      ğŸ§® Ø§Ø­Ø³Ø¨ Ù…Ù†ØªØ¬Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
    </button>

    <!-- Last result summary (hidden until calc done) -->
    <div id="lastResult" class="hidden fade-up d5">
      <div class="card p-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm font-700">Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨</span>
          <span class="text-xs muted" id="lastProd">â€”</span>
        </div>
        <div id="breakTable" class="space-y-2 text-sm"></div>
      </div>
    </div>

    <!-- Chart -->
    <div id="chartWrap" class="hidden card p-4 fade-up d6">
      <p class="text-sm font-700 mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</p>
      <div style="height:220px;position:relative">
        <canvas id="costChart"></canvas>
      </div>
    </div>

    <!-- Not logged in prompt -->
    <div id="guestPrompt" class="card p-6 text-center fade-up d5">
      <div class="text-4xl mb-3">ğŸ”</div>
      <h3 class="font-800 text-base mb-2">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬Ùƒ</h3>
      <p class="text-xs muted mb-5 leading-relaxed">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¢Ù…Ù†Ø§Ù‹ ÙÙŠ Supabase. Ù…Ø¬Ø§Ù†Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¯.</p>
      <button class="btn btn-teal btn-full" onclick="openModal()">Ø§Ø¨Ø¯Ø£ Ù…Ø¬Ø§Ù†Ø§Ù‹</button>
    </div>

  </div>

  <!-- â”€â”€â”€ CALCULATOR VIEW â”€â”€â”€ -->
  <div id="calcView" class="hidden px-4 py-5 space-y-5">

    <div class="flex items-center gap-3 mb-2">
      <button onclick="showDash()" class="w-9 h-9 rounded-full btn-ghost flex items-center justify-center text-lg" style="font-size:20px">â†</button>
      <div>
        <h2 class="text-xl font-black">Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</h2>
        <p class="text-xs muted">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ù…Ù‘Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
      </div>
    </div>

    <!-- Product & Pricing -->
    <div class="card p-5">
      <p class="text-sm font-800 mb-4 flex items-center gap-2"><span>ğŸ“¦</span> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</p>
      <div class="space-y-4">
        <div>
          <label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="text" id="cProdName" class="field" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø§ÙƒÙŠØª Ø´ØªÙˆÙŠ"/>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¯.Ù….)</label>
            <input type="number" id="cCost" class="field" placeholder="80" value="80" min="0" step="0.5" inputmode="decimal" oninput="liveCalc()"/>
          </div>
          <div>
            <label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input type="number" id="cQty" class="field" placeholder="100" value="100" min="1" inputmode="numeric" oninput="liveCalc()"/>
          </div>
        </div>
        <div>
          <label class="field-label">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (%)</label>
          <div class="flex items-center gap-3">
            <input type="range" id="cMargin" min="5" max="80" value="30" oninput="document.getElementById('cMarginLbl').textContent=this.value+'%'; liveCalc()" class="flex-1"/>
            <span class="font-800 w-12 text-center teal" id="cMarginLbl">30%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Costs (loaded from defaults) -->
    <div class="card p-5">
      <div class="flex justify-between items-center mb-4">
        <p class="text-sm font-800 flex items-center gap-2"><span>ğŸšš</span> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>
        <button onclick="window.location.href='settings.html'" class="text-xs teal font-700">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ â†</button>
      </div>
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="field-label">Ø§Ù„Ø´Ø­Ù† (Ø¯.Ù….)</label>
            <input type="number" id="cShip" class="field" value="25" min="0" step="0.5" inputmode="decimal" oninput="liveCalc()"/>
          </div>
          <div>
            <label class="field-label">Ø§Ù„ØªØ¹Ø¨Ø¦Ø© (Ø¯.Ù….)</label>
            <input type="number" id="cPack" class="field" value="5" min="0" step="0.5" inputmode="decimal" oninput="liveCalc()"/>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="field-label">Ø§Ù„ØªØ³ÙˆÙŠÙ‚ (Ø¯.Ù….)</label>
            <input type="number" id="cMktg" class="field" value="15" min="0" step="0.5" inputmode="decimal" oninput="liveCalc()"/>
          </div>
          <div>
            <label class="field-label">Ø£Ø®Ø±Ù‰ (Ø¯.Ù….)</label>
            <input type="number" id="cOther" class="field" value="0" min="0" step="0.5" inputmode="decimal" oninput="liveCalc()"/>
          </div>
        </div>
      </div>
    </div>

    <!-- Tax & Returns -->
    <div class="card p-5">
      <p class="text-sm font-800 mb-4 flex items-center gap-2"><span>âš–ï¸</span> Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ÙˆØ§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</p>
      <div class="space-y-4">
        <!-- TVA -->
        <div>
          <div class="flex justify-between mb-2">
            <label class="field-label mb-0">Ø¶Ø±ÙŠØ¨Ø© TVA</label>
            <span class="text-sm font-800 teal" id="cTvaLbl">20%</span>
          </div>
          <div class="tab-row" id="tvaRow">
            <button class="tab-btn-sm" onclick="setTVA(0,this)">0%</button>
            <button class="tab-btn-sm" onclick="setTVA(7,this)">7%</button>
            <button class="tab-btn-sm" onclick="setTVA(10,this)">10%</button>
            <button class="tab-btn-sm" onclick="setTVA(14,this)">14%</button>
            <button class="tab-btn-sm active" onclick="setTVA(20,this)">20%</button>
          </div>
        </div>
        <!-- Return rate -->
        <div>
          <div class="flex justify-between mb-2">
            <label class="field-label mb-0">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (COD)</label>
            <span class="text-sm font-800" id="cRetLbl" style="color:var(--red)">15%</span>
          </div>
          <input type="range" id="cRet" min="0" max="60" value="15" step="1" oninput="onRetSlide(this.value)"/>
          <div class="flex justify-between text-10 muted mt-1" style="font-size:10px">
            <span>Ù…Ù…ØªØ§Ø² 0-10%</span><span>Ù…ØªÙˆØ³Ø· 10-30%</span><span>Ø¹Ø§Ù„Ù +30%</span>
          </div>
        </div>
        <!-- Return cost -->
        <div>
          <div class="flex justify-between mb-2">
            <label class="field-label mb-0">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø¯.Ù….)</label>
            <span class="text-sm font-800 muted" id="cRetCostLbl">20</span>
          </div>
          <input type="range" id="cRetCost" min="0" max="80" value="20" step="5" oninput="document.getElementById('cRetCostLbl').textContent=this.value; liveCalc()"/>
        </div>
      </div>
    </div>

    <!-- Live Preview -->
    <div class="card p-4" id="livePreview">
      <p class="text-xs muted mb-3 font-600">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©</p>
      <div class="grid grid-cols-3 gap-3 text-center">
        <div>
          <div class="text-xs muted mb-1">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</div>
          <div class="font-900 text-base" id="lpCost">â€”</div>
        </div>
        <div style="border-right:1px solid var(--border);border-left:1px solid var(--border)">
          <div class="text-xs muted mb-1">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­</div>
          <div class="font-900 text-base teal" id="lpSuggest">â€”</div>
        </div>
        <div>
          <div class="text-xs muted mb-1">Ø§Ù„Ù‡Ø§Ù…Ø´</div>
          <div class="font-900 text-base" id="lpMargin" style="color:var(--gold)">â€”</div>
        </div>
      </div>
    </div>

    <!-- Calculate Button -->
    <button class="btn btn-gold btn-full py-4 text-base" onclick="doCalculate()">
      âœ¨ Ø§Ø­Ø³Ø¨ ÙˆØ£Ø±Ù†ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    </button>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden space-y-4">

      <!-- Price Interval -->
      <div class="ai-card">
        <div class="text-xs font-700 muted mb-3">ğŸ’¡ ØªÙˆØµÙŠØ© Ø³Ø¹Ø±ÙŠØ©</div>
        <div class="price-interval" id="priceIntervalBox">
          <div class="label">Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡</div>
          <div class="range" id="priceIntervalVal">--- Ø¯.Ù….</div>
        </div>
        <div id="aiText" class="text-sm leading-relaxed" style="color:rgba(232,240,255,0.8); line-height:1.9"></div>
        <div id="aiLoading" class="hidden text-center py-4">
          <div class="dots mb-2"><span></span><span></span><span></span></div>
          <div class="text-xs muted">Llama 3 ÙŠØ­Ù„Ù„ Ø£Ø±Ù‚Ø§Ù…Ùƒ...</div>
        </div>
        <div class="flex justify-between items-center mt-4 pt-3" style="border-top:1px solid rgba(0,212,184,0.12)">
          <button class="btn btn-ghost py-2 px-4 text-xs" onclick="getAI()">ğŸ”„ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ <span class="token-chip" style="font-size:10px;padding:2px 8px">1 ğŸª™</span></button>
          <button class="btn btn-ghost py-2 px-3 text-xs" onclick="copyAI()">Ù†Ø³Ø® ğŸ“‹</button>
        </div>
      </div>

      <!-- Breakdown -->
      <div class="card p-4">
        <p class="text-sm font-800 mb-4">ğŸ“‹ Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</p>
        <div id="breakdownList" class="space-y-2"></div>
      </div>

      <!-- Chart -->
      <div class="card p-4">
        <p class="text-sm font-700 mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</p>
        <div style="height:200px;position:relative">
          <canvas id="donutChart"></canvas>
        </div>
      </div>
    </div>

  </div>
</div><!-- /main-content -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="bottom-nav md:hidden">
  <a href="index.html" class="nav-item active">
    <div class="nav-icon">ğŸ“Š</div>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
  </a>
  <button class="nav-item" onclick="showCalc()" style="background:none;border:none;font-family:'Cairo',sans-serif">
    <div class="nav-icon">ğŸ§®</div>
    <span>Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</span>
  </button>
  <a href="settings.html" class="nav-item">
    <div class="nav-icon">âš™ï¸</div>
    <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
  </a>
  <a href="rewards.html" class="nav-item">
    <div class="nav-icon">ğŸ</div>
    <span>Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</span>
  </a>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸  CONFIG â€” Replace with your actual keys
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL  = 'https://YOUR_PROJECT.supabase.co';
const SUPABASE_ANON = 'YOUR_ANON_KEY';
const GROQ_API_KEY  = 'YOUR_GROQ_API_KEY';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

let currentUser    = null;
let userProfile    = null;
let userTokens     = 0;
let tvaVal         = 20;
let calcData       = null;
let donutChartInst = null;

// Load defaults from localStorage on startup
document.addEventListener('DOMContentLoaded', () => {
  loadDefaults();
  sb.auth.onAuthStateChange(async (evt, session) => {
    currentUser = session?.user || null;
    if (currentUser) {
      await fetchProfile();
      updateAuthUI(true);
    } else {
      updateAuthUI(false);
    }
  });
  // Check URL ref
  const ref = new URLSearchParams(location.search).get('ref');
  if (ref) { document.getElementById('iRef').value = ref; switchTab('signup'); }
});

// â”€â”€ Load defaults from localStorage â”€â”€
function loadDefaults() {
  const d = JSON.parse(localStorage.getItem('ribhi_settings') || '{}');
  if (d.ship)   document.getElementById('cShip').value  = d.ship;
  if (d.pack)   document.getElementById('cPack').value  = d.pack;
  if (d.mktg)   document.getElementById('cMktg').value  = d.mktg;
  if (d.tva != null) {
    tvaVal = d.tva;
    document.getElementById('cTvaLbl').textContent = d.tva + '%';
    document.querySelectorAll('#tvaRow .tab-btn-sm').forEach(b => {
      b.classList.toggle('active', b.textContent.trim() === d.tva + '%');
    });
  }
  liveCalc();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authTab = 'login';
function openModal() { document.getElementById('authModal').classList.add('open'); }
function closeModal() { document.getElementById('authModal').classList.remove('open'); }

function switchTab(tab) {
  authTab = tab;
  const isS = tab === 'signup';
  document.getElementById('tl').classList.toggle('active', !isS);
  document.getElementById('ts').classList.toggle('active', isS);
  document.getElementById('fName').classList.toggle('hidden', !isS);
  document.getElementById('fRef').classList.toggle('hidden', !isS);
  document.getElementById('sheetTitle').textContent = isS ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  document.getElementById('authBtnLbl').textContent  = isS ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'Ø¯Ø®ÙˆÙ„';
}

async function doAuth(e) {
  e.preventDefault();
  const email = document.getElementById('iEmail').value.trim();
  const pass  = document.getElementById('iPass').value;
  const name  = document.getElementById('iName').value.trim();
  const ref   = document.getElementById('iRef').value.trim();
  const btn   = document.getElementById('authBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  try {
    if (authTab === 'signup') {
      const { data, error } = await sb.auth.signUp({ email, password: pass, options: { data: { full_name: name } } });
      if (error) throw error;
      if (data.user) {
        const code = 'REF-' + data.user.id.slice(0,6).toUpperCase();
        await sb.from('profiles').insert({ id: data.user.id, email, full_name: name || email.split('@')[0], tokens: 100, referral_code: code, referred_by: ref || null });
        if (ref) await sb.rpc('reward_referral', { ref_code: ref, new_user_id: data.user.id });
      }
      toast('ğŸ‰ ØªÙ…! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
    } else {
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      toast('ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!');
    }
    closeModal();
  } catch (err) {
    toast('âŒ ' + (err.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'), true);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span id="authBtnLbl">' + (authTab === 'login' ? 'Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨') + '</span>';
  }
}

async function doSignOut() {
  await sb.auth.signOut();
  currentUser = null; userProfile = null; userTokens = 0;
  updateAuthUI(false);
  toast('ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchProfile() {
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) {
    userProfile = data;
    userTokens  = data.tokens || 0;
  } else {
    userTokens = 0;
  }
  refreshStats();
}

function updateAuthUI(loggedIn) {
  const name = userProfile?.full_name || currentUser?.email?.split('@')[0] || '';
  document.getElementById('greetName').textContent = loggedIn ? (name + ' ğŸ‘‹') : 'Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…ØºØ±Ø¨ÙŠ ğŸ‘‹';
  document.getElementById('guestPrompt').classList.toggle('hidden', loggedIn);
  document.getElementById('topAvatar').textContent = loggedIn ? (name.charAt(0).toUpperCase() || '?') : '?';
  document.getElementById('sdkAuthBtn').classList.toggle('hidden', loggedIn);
  document.getElementById('sdkSignOut').classList.toggle('hidden', !loggedIn);
  document.getElementById('sdkUserInfo').textContent = loggedIn ? (currentUser?.email || '') : '';
  refreshStats();
}

function refreshStats() {
  const tokens = currentUser ? userTokens : 'â€”';
  document.getElementById('s-tokens').textContent    = tokens;
  document.getElementById('topTokenChip').innerHTML  = 'ğŸª™ ' + tokens + ' Ø±ØµÙŠØ¯';
  document.getElementById('sdkTokens').innerHTML     = 'ğŸª™ ' + tokens + ' Ø±ØµÙŠØ¯';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDash() {
  document.getElementById('dashView').classList.remove('hidden');
  document.getElementById('calcView').classList.add('hidden');
}
function showCalc() {
  document.getElementById('dashView').classList.add('hidden');
  document.getElementById('calcView').classList.remove('hidden');
  liveCalc();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TVA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTVA(v, btn) {
  tvaVal = v;
  document.getElementById('cTvaLbl').textContent = v + '%';
  document.querySelectorAll('#tvaRow .tab-btn-sm').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  liveCalc();
}

function onRetSlide(v) {
  const lbl = document.getElementById('cRetLbl');
  lbl.textContent = v + '%';
  lbl.style.color = v < 10 ? 'var(--teal)' : v < 25 ? 'var(--gold)' : 'var(--red)';
  liveCalc();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE CALCULATOR (instant preview)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function liveCalc() {
  const cost    = parseFloat(document.getElementById('cCost').value) || 0;
  const ship    = parseFloat(document.getElementById('cShip').value) || 0;
  const pack    = parseFloat(document.getElementById('cPack').value) || 0;
  const mktg    = parseFloat(document.getElementById('cMktg').value) || 0;
  const other   = parseFloat(document.getElementById('cOther').value) || 0;
  const margin  = parseInt(document.getElementById('cMargin').value) || 30;
  const retRate = parseFloat(document.getElementById('cRet').value) / 100 || 0;
  const retCost = parseFloat(document.getElementById('cRetCost').value) || 0;

  // Total cost per sold unit (accounting for returns: every "retRate" unit costs extra)
  const totalCostPerUnit = cost + ship + pack + mktg + other + (retCost * retRate);
  const tvaFactor = 1 - (tvaVal / 100);

  // Suggested price to hit target margin:
  // netRevenue = salePrice * tvaFactor
  // profit = netRevenue - totalCostPerUnit = margin% * netRevenue
  // â†’ salePrice = totalCostPerUnit / (tvaFactor * (1 - margin/100))
  const denominator = tvaFactor * (1 - margin / 100);
  const suggestedPrice = denominator > 0 ? totalCostPerUnit / denominator : 0;

  document.getElementById('lpCost').textContent    = totalCostPerUnit.toFixed(1) + ' Ø¯.Ù….';
  document.getElementById('lpSuggest').textContent = suggestedPrice > 0 ? Math.ceil(suggestedPrice) + ' Ø¯.Ù….' : 'â€”';
  document.getElementById('lpMargin').textContent  = margin + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN CALCULATE (full risk-adjusted)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doCalculate() {
  const prodName  = document.getElementById('cProdName').value || 'Ù…Ù†ØªØ¬';
  const cost      = parseFloat(document.getElementById('cCost').value)    || 0;
  const qty       = parseInt(document.getElementById('cQty').value)       || 1;
  const ship      = parseFloat(document.getElementById('cShip').value)    || 0;
  const pack      = parseFloat(document.getElementById('cPack').value)    || 0;
  const mktg      = parseFloat(document.getElementById('cMktg').value)    || 0;
  const other     = parseFloat(document.getElementById('cOther').value)   || 0;
  const margin    = parseInt(document.getElementById('cMargin').value)    || 30;
  const retRate   = parseFloat(document.getElementById('cRet').value) / 100 || 0;
  const retCost   = parseFloat(document.getElementById('cRetCost').value) || 0;
  const tvaPct    = tvaVal / 100;

  // â”€â”€ Risk-Adjusted Math â”€â”€
  const soldUnits    = qty * (1 - retRate);
  const retUnits     = qty * retRate;

  // Cost per sold unit (you pay for all units but only sell some)
  const totalGoods   = cost * qty;
  const totalShip    = ship * qty;
  const totalPack    = pack * qty;
  const totalMktg    = mktg * soldUnits;   // marketing only on actual sold
  const totalOther   = other * qty;
  const totalReturn  = retCost * retUnits;
  const totalCosts   = totalGoods + totalShip + totalPack + totalMktg + totalOther + totalReturn;

  // Suggested price (target margin)
  const costPerSold  = soldUnits > 0 ? totalCosts / soldUnits : 0;
  const tvaFactor    = 1 - tvaPct;
  const denom        = tvaFactor * (1 - margin / 100);
  const suggestedMin = denom > 0 ? Math.ceil(costPerSold / denom) : 0;
  // Upper bound: 15% above minimum
  const suggestedMax = Math.ceil(suggestedMin * 1.15);

  // Revenue at suggested MIN price
  const revenueGross = suggestedMin * soldUnits;
  const tvaAmount    = revenueGross * tvaPct;
  const revenueNet   = revenueGross - tvaAmount;
  const netProfit    = revenueNet - totalCosts;
  const profitMargin = revenueNet > 0 ? (netProfit / revenueNet) * 100 : 0;
  const roi          = totalCosts > 0 ? (netProfit / totalCosts) * 100 : 0;
  const deliveryRate = (1 - retRate) * 100;

  calcData = { prodName, cost, qty, ship, pack, mktg, other, retRate, retCost, tvaPct, tvaVal,
    soldUnits, retUnits, totalGoods, totalShip, totalPack, totalMktg, totalOther, totalReturn,
    totalCosts, revenueGross, tvaAmount, revenueNet, netProfit, profitMargin, roi, deliveryRate,
    suggestedMin, suggestedMax, margin };

  // â”€â”€ Update UI â”€â”€
  const fmt = n => Math.round(n).toLocaleString('ar-MA');

  // Price interval
  document.getElementById('priceIntervalVal').textContent = fmt(suggestedMin) + ' â€” ' + fmt(suggestedMax) + ' Ø¯.Ù….';

  // Breakdown list
  const lines = [
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©',   -totalGoods,  'var(--red)'],
    ['ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†',      -totalShip,   'var(--red)'],
    ['Ø§Ù„ØªØ¹Ø¨Ø¦Ø©',          -totalPack,   'var(--red)'],
    ['Ø§Ù„ØªØ³ÙˆÙŠÙ‚',          -totalMktg,   'var(--red)'],
    ['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª',  -totalReturn, 'var(--red)'],
    ['TVA (' + tvaVal + '%)', -tvaAmount,'#60A5FA'],
    ['ØªÙƒØ§Ù„ÙŠÙ Ø£Ø®Ø±Ù‰',      -totalOther,  'var(--red)'],
    ['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµØ§ÙÙŠ',    revenueNet,  'var(--teal)'],
  ];
  const breakDiv = document.getElementById('breakdownList');
  breakDiv.innerHTML = lines.map(([lbl, val, col]) => `
    <div class="flex justify-between items-center py-2" style="border-bottom:1px solid var(--border)">
      <span class="text-sm" style="color:rgba(232,240,255,0.7)">${lbl}</span>
      <span class="font-800 text-sm" style="color:${col}">${val >= 0 ? '+' : ''}${Math.round(Math.abs(val)).toLocaleString('ar-MA')} Ø¯.Ù….</span>
    </div>`).join('') + `
    <div class="flex justify-between items-center pt-3">
      <span class="font-800">ğŸ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</span>
      <span class="font-900 text-base" style="color:${netProfit >= 0 ? 'var(--teal)' : 'var(--red)'}">
        ${netProfit >= 0 ? '+' : ''}${fmt(netProfit)} Ø¯.Ù….
      </span>
    </div>`;

  // Dashboard stats
  document.getElementById('s-profit').textContent   = fmt(netProfit) + ' Ø¯.Ù….';
  document.getElementById('s-profit').style.color   = netProfit >= 0 ? 'var(--teal)' : 'var(--red)';
  document.getElementById('s-roi').textContent      = roi.toFixed(1) + '%';
  document.getElementById('s-delivery').textContent = deliveryRate.toFixed(0) + '%';

  // Health bar
  const health = Math.max(0, Math.min(100, profitMargin * 2));
  document.getElementById('healthFill').style.width = health + '%';
  const labels = profitMargin >= 30 ? ['Ù…Ù…ØªØ§Ø² ğŸŒŸ','var(--teal)'] : profitMargin >= 15 ? ['Ø¬ÙŠØ¯ âœ…','#7ee787'] : profitMargin >= 0 ? ['Ù…Ù‚Ø¨ÙˆÙ„ âš ï¸','var(--gold)'] : ['Ø®Ø³Ø§Ø±Ø© âŒ','var(--red)'];
  document.getElementById('healthLbl').textContent = labels[0];
  document.getElementById('healthLbl').style.color  = labels[1];

  // Last result
  document.getElementById('lastProd').textContent = prodName;
  document.getElementById('breakTable').innerHTML = `
    <div class="flex justify-between text-sm py-1"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­</span><span class="teal font-800">${fmt(suggestedMin)} â€” ${fmt(suggestedMax)} Ø¯.Ù….</span></div>
    <div class="flex justify-between text-sm py-1"><span class="muted">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</span><span style="color:${netProfit>=0?'var(--teal)':'var(--red)'}; font-weight:800">${fmt(netProfit)} Ø¯.Ù….</span></div>
    <div class="flex justify-between text-sm py-1"><span class="muted">ROI</span><span class="gold font-800">${roi.toFixed(1)}%</span></div>`;
  document.getElementById('lastResult').classList.remove('hidden');

  // Donut chart
  buildDonut(totalGoods, totalShip, totalPack, totalMktg, totalReturn, tvaAmount, Math.max(0, netProfit));

  // Show results, go back to dash for overview
  document.getElementById('resultsSection').classList.remove('hidden');
  document.getElementById('resultsSection').scrollIntoView({ behavior:'smooth', block:'start' });

  // Auto-trigger AI
  getAI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONUT CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDonut(goods, ship, pack, mktg, ret, tva, profit) {
  const ctx = document.getElementById('donutChart').getContext('2d');
  if (donutChartInst) { donutChartInst.destroy(); }
  donutChartInst = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©','Ø§Ù„Ø´Ø­Ù†','Ø§Ù„ØªØ¹Ø¨Ø¦Ø©','Ø§Ù„ØªØ³ÙˆÙŠÙ‚','Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª','TVA','Ø§Ù„Ø±Ø¨Ø­'],
      datasets: [{ data: [goods,ship,pack,mktg,ret,tva,profit].map(Math.abs),
        backgroundColor: ['#ef4444','#f97316','#eab308','#a855f7','#ff4d6d','#60a5fa','#00d4b8'],
        borderWidth: 0, hoverOffset: 6 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position:'right', labels:{ color:'#6B7A99', font:{ family:'Cairo', size:10 }, padding:8, boxWidth:10 } },
        tooltip: { callbacks: { label: c => ' ' + c.label + ': ' + Math.round(c.raw).toLocaleString() + ' Ø¯.Ù….' } }
      },
      cutout: '62%'
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ADVICE (Groq â€” Llama 3 70b)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getAI() {
  if (!calcData) return;
  if (!currentUser) { toast('ğŸ” Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©'); return; }
  if (userTokens <= 0) { toast('ğŸª™ Ø±ØµÙŠØ¯Ùƒ Ù†ÙØ°! Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²ÙŠØ¯', true); return; }

  const d = calcData;
  document.getElementById('aiText').textContent = '';
  document.getElementById('aiLoading').classList.remove('hidden');

  const systemPrompt = `Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØºØ±Ø¨ÙŠ (COD - Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…).
Ù…Ù‡Ù…ØªÙƒ: ØªØ­Ù„ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙˆØªÙ‚Ø¯ÙŠÙ… ØªÙˆØµÙŠØ§Øª **Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ±Ø§Ù‹** Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
Ø§Ù„Ø£Ø³Ù„ÙˆØ¨: Ø¹Ø±Ø¨ÙŠ Ù…Ù‡Ù†ÙŠ Ù…ÙˆØ¬Ø²ØŒ ÙÙ‚Ø±Ø§Øª Ù‚ØµÙŠØ±Ø©ØŒ Ù„Ø§ Ù…Ù‚Ø¯Ù…Ø§ØªØŒ Ù„Ø§ ÙƒÙ„Ø§Ù… Ø¹Ø§Ù….
IMPORTANT: ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø³Ø·Ø± ÙŠØ°ÙƒØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ Ø¨Ø§Ù„Ø¶Ø¨Ø·:
"ğŸ’° Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: [X] â€” [Y] Ø¯Ø±Ù‡Ù…"`;

  const userMsg = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬: ${d.prodName}
- Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${d.cost} Ø¯.Ù…. | Ø§Ù„ÙƒÙ…ÙŠØ©: ${d.qty} ÙˆØ­Ø¯Ø©
- ØªÙƒØ§Ù„ÙŠÙ/ÙˆØ­Ø¯Ø©: Ø´Ø­Ù† ${d.ship} + ØªØ¹Ø¨Ø¦Ø© ${d.pack} + ØªØ³ÙˆÙŠÙ‚ ${d.mktg} + Ø£Ø®Ø±Ù‰ ${d.other}
- TVA: ${d.tvaVal}% | Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª: ${(d.retRate*100).toFixed(0)}% | ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: ${d.retCost} Ø¯.Ù….
- Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙØ¹Ù„Ø§Ù‹: ${Math.round(d.soldUnits)} Ù…Ù† ${d.qty}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ: ${Math.round(d.totalCosts)} Ø¯.Ù….
- Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (${d.suggestedMin} Ø¯.Ù….): ${Math.round(d.netProfit)} Ø¯.Ù….
- ROI: ${d.roi.toFixed(1)}% | Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­: ${d.profitMargin.toFixed(1)}% | Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${d.deliveryRate.toFixed(0)}%

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
1. Ø³Ø·Ø± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ (Ø¥Ù„Ø²Ø§Ù…ÙŠ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª)
2. Ø£Ù‡Ù… 2 Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
3. 2 Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ù„Ø±ÙØ¹ Ø§Ù„Ø±Ø¨Ø­ÙŠØ©
4. Ø³Ø¹Ø± Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (BEP) Ø¨Ø§Ù„Ø¯Ø±Ù‡Ù…`;

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + GROQ_API_KEY },
      body: JSON.stringify({
        model: 'llama3-70b-8192',
        messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userMsg }],
        max_tokens: 500, temperature: 0.65
      })
    });
    if (!res.ok) throw new Error('Groq ' + res.status);
    const json   = await res.json();
    const advice = json.choices?.[0]?.message?.content || 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ©.';

    // Extract price interval from AI response if present
    const match = advice.match(/Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡:\s*([\dÙ -Ù©]+)\s*[â€”â€“-]\s*([\dÙ -Ù©]+)/);
    if (match) {
      document.getElementById('priceIntervalVal').textContent = match[1] + ' â€” ' + match[2] + ' Ø¯Ø±Ù‡Ù…';
    }

    document.getElementById('aiText').textContent = advice;

    // Deduct token
    userTokens = Math.max(0, userTokens - 1);
    await sb.from('profiles').update({ tokens: userTokens }).eq('id', currentUser.id);
    await sb.from('token_usage').insert({ user_id: currentUser.id, action: 'ai_advice', product_name: d.prodName, tokens_used: 1 });
    refreshStats();

  } catch (err) {
    document.getElementById('aiText').textContent = 'âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ Groq API.';
    console.error(err);
  } finally {
    document.getElementById('aiLoading').classList.add('hidden');
  }
}

function copyAI() {
  navigator.clipboard.writeText(document.getElementById('aiText').textContent)
    .then(() => toast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙˆØµÙŠØ©'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTimer;
function toast(msg, err = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.borderColor = err ? 'rgba(255,77,109,0.4)' : 'rgba(0,212,184,0.3)';
  el.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 3200);
}
</script>
</body>
</html>
